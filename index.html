<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Грандаксин против</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#000; overflow:hidden; height:100vh; color:white; }
    #ui { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:10; }
    #timer { position:absolute; top:20px; left:50%; transform:translateX(-50%); background:rgba(2,122,202,0.9); padding:12px 30px; border-radius:30px; font-size:2.5em; font-weight:900; }
    #progress { position:absolute; top:90px; left:20px; right:20px; display:flex; gap:15px; }
    .bar { flex:1; height:45px; background:rgba(255,255,255,0.2); border-radius:25px; overflow:hidden; position:relative; }
    .fill { height:100%; width:0%; background:linear-gradient(90deg, #00859D, #00b894); transition:width 0.6s ease; }
    .label { position:absolute; top:50%; left:15px; transform:translateY(-50%); font-size:14px; font-weight:700; color:white; text-shadow:0 0 10px black; }
    #hint { position:absolute; bottom:30px; left:0; right:0; text-align:center; font-size:1.4em; background:rgba(0,0,0,0.6); padding:15px; border-radius:15px; margin:0 20px; }

    model-viewer { width:100vw; height:100vh; background:#000; }
    #startBtn { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; padding:20px 70px; font-size:2em; background:#027ACA; color:white; border:none; border-radius:50px; box-shadow:0 15px 40px rgba(0,0,0,0.5); cursor:pointer; }
  </style>
</head>
<body>

  <button id="startBtn">НАЧАТЬ ИГРУ В AR1</button>

  <div id="ui" style="display:none">
    <div id="timer">30</div>
    <div id="progress">
      <div class="bar"><div class="label">Нервозность</div><div id="nerv-fill" class="fill"></div></div>
      <div class="bar"><div class="label">Тревога</div><div id="anx-fill" class="fill"></div></div>
      <div class="bar"><div class="label">Стресс</div><div id="stress-fill" class="fill"></div></div>
    </div>
    <div id="hint">Нажмите на симптом, чтобы уничтожить!</div>
  </div>

  <model-viewer
    id="ar"
    src="scene.glb"
    ios-src="scene.usdz"
    ar
    ar-modes="scene-viewer quick-look webxr"
    ar-scale="auto"
    camera-controls
    touch-action="pan-y"
    disable-zoom
    shadow-intensity="1"
    exposure="1.0"
    environment-image="neutral"
    skybox-image="neutral"
    style="display:none">

    <button slot="ar-button" style="display:none"></button>
  </model-viewer>

  <script>
    const viewer = document.getElementById('ar');
    const startBtn = document.getElementById('startBtn');
    const ui = document.getElementById('ui');
    let scores = { nerv:0, anx:0, stress:0 };
    let timeLeft = 30;
    let timer;

    startBtn.onclick = () => {
      startBtn.style.display = 'none';
      ui.style.display = 'block';
      viewer.style.display = 'block';
      viewer.activateAR();

      timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0) endGame();
      }, 1000);
    };

    function endGame() {
      clearInterval(timer);
      alert(`Игра окончена!\n\nНервозность: ${scores.nerv}\nТревога: ${scores.anx}\nСтресс: ${scores.stress}\n\nСпасибо за игру!`);
      location.reload();
    }

    // Клик по моделям (работает в AR!)
    viewer.addEventListener('load', () => {
      const scene = viewer.model;
      scene.addEventListener('click', (ev) => {
        if (timeLeft <= 0) return;
        const target = ev.target;
        if (!target) return;

        const name = target.material?.name || '';
        if (name.includes('nerv')) { scores.nerv++; updateBar('nerv-fill'); playHit(); }
        if (name.includes('anx'))  { scores.anx++;  updateBar('anx-fill');  playHit(); }
        if (name.includes('stress')){ scores.stress++; updateBar('stress-fill'); playHit(); }

        target.parent.removeChild(target);
      });
    });

    function updateBar(id) {
      const el = document.getElementById(id);
      const percent = Math.min((scores[id.split('-')[0]] || scores[id.split('-')[0]]) * 10, 100);
      el.style.width = percent + '%';
    }

    function playHit() {
      const audio = new Audio('https://assets.codepen.io/605876/sfx-hit.mp3');
      audio.volume = 0.5;
      audio.play().catch(() => {});
    }
  </script>
</body>
</html>
