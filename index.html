<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Грандаксин против</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar-nft.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,#027ACA 0%,#00b894 100%);
      overflow:hidden;
      height:100vh;
      color:white;
    }

    /* Адаптивные отступы */
    .container {
      padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 20px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 20px);
      padding: 5vh 5vw;
      max-width: 500px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #startPage, #endScreen {
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(255,255,255,0.96);
      color: #027ACA;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    #endScreen { display: none; background: rgba(2,122,202,0.98); color: white; }

    #logo {
      font-size: clamp(2.2rem, 8vw, 4rem);
      font-weight: 900;
      margin-bottom: 2vh;
      line-height: 1.1;
    }

    #rules {
      font-size: clamp(1.1rem, 4.5vw, 1.6rem);
      line-height: 1.6;
      margin: 4vh 0;
      max-width: 90%;
    }

    button {
      padding: 16px 50px;
      background: #027ACA;
      color: white;
      font-size: clamp(1.3rem, 5vw, 1.8rem);
      font-weight: bold;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(2,122,202,0.4);
      transition: transform 0.3s;
      min-width: 220px;
    }
    button:hover { transform: scale(1.08); }
    #playAgainBtn { background: white; color: #027ACA; }

    }

    /* Игровой UI — адаптивный */
    #gameUI {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1000;
      padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 16px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 16px);
      padding: 4vh 4vw;
      display: none;
    }

    #timer {
      position: absolute;
      top: 3vh;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      color: #027ACA;
      padding: 10px 28px;
      border-radius: 30px;
      font-size: clamp(2rem, 7vw, 3.5rem);
      font-weight: 900;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    #progress {
      position: absolute;
      top: 14vh;
      left: 5vw;
      right: 5vw;
      width: 90vw;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .progress-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bar {
      flex: 1;
      height: 50px;
      background: rgba(255,255,255,0.2);
      border-radius: 25px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
    }

    .fill {
      height: 100%;
      width: 0%;
      transition: width 0.8s ease;
      border-radius: 25px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 16px;
      font-weight: bold;
      font-size: 1.1rem;
      color: white;
      text-shadow: 1px 1px 3px black;
    }

    .label {
      width: 100px;
      text-align: left;
      font-size: clamp(0.9rem, 3.5vw, 1.2rem);
      font-weight: 700;
    }

    #nerv-fill   { background: #00859D; }
    #anx-fill    { background: #411D6B; }
    #stress-fill { background: #EB4C24; }

    #uiText {
      position: absolute;
      bottom: 5vh;
      left: 5vw;
      right: 5vw;
      background: rgba(255,255,255,0.94);
      color: #027ACA;
      padding: 16px 20px;
      border-radius: 20px;
      font-size: clamp(1rem, 4vw, 1.4rem);
      font-weight: 600;
      text-align: center;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
    }

    /* Финальный экран */
    #endTitle {
      font-size: clamp(2rem, 7vw, 3.5rem);
      font-weight: 900;
      margin-bottom: 4vh;
    }

    #finalResultText {
      font-size: clamp(1.3rem, 5vw, 2rem);
      margin: 4vh 0;
      text-align: center;
      line-height: 1.5;
    }

    #endProgress {
      width: 90vw;
      max-width: 460px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 4vh 0;
    }
  </style>
</head>
<body>

  <!-- Старт -->
  <div id="startPage" class="container">
    <div id="logo">ГРАНДАКСИН<br>ПРОТИВ</div>
    <div id="rules">Совместите прицел с симптомом<br>и нажмите на экран<br><br>Уничтожьте как можно больше за 30 секунд!</div>
    <button id="startGameBtn">НАЧАТЬ ИГРУ</button>
  </div>

  <!-- Игровой интерфейс -->
  <div id="gameUI">
    <div id="timer">30</div>
    <div id="progress">
      <div class="progress-row"><div class="label">Нервозность</div><div class="bar"><div id="nerv-fill" class="fill">0</div></div></div>
      <div class="progress-row"><div class="label">Тревога</div><div class="bar"><div id="anx-fill" class="fill">0</div></div></div>
      <div class="progress-row"><div class="label">Стресс</div><div class="bar"><div id="stress-fill" class="fill">0</div></div></div>
    </div>
    <div id="uiText">Наведите прицел и нажмите на симптом</div>
  </div>

  <!-- Финал -->
  <div id="endScreen" class="container">
    <div id="endTitle">Отличный результат!</div>
    <div id="finalResultText">Вы уничтожили</div>
    <div id="endProgress">
      <div class="progress-row"><div class="label">Нервозность</div><div class="bar"><div id="end-nerv-fill" class="fill">0</div></div></div>
      <div class="progress-row"><div class="label">Тревога</div><div class="bar"><div id="end-anx-fill" class="fill">0</div></div></div>
      <div class="progress-row"><div class="label">Стресс</div><div class="bar"><div id="end-stress-fill" class="fill">0</div></div></div>
    </div>
    <button id="playAgainBtn">ИГРАТЬ ЕЩЁ РАЗ</button>
  </div>

  <!-- AR сцена -->
  <a-scene embedded arjs="trackingMethod:best;sourceType:webcam;debugUIEnabled:false" 
           renderer="antialias:true" vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false"
           style="display:none" raycaster="objects:.clickable" cursor="rayOrigin:mouse">
    
    <a-assets timeout="120000">
      <a-asset-item id="nerv"    src="red.glb"></a-asset-item>
      <a-asset-item id="anx"     src="green.glb"></a-asset-item>
      <a-asset-item id="stress"  src="blue.glb"></a-asset-item>
      <a-asset-item id="destruction" src="destruction.glb"></a-asset-item>
      <audio id="hit-sound" src="hit.mp3" preload="auto"></audio>
    </a-assets>

    <a-entity id="models"></a-entity>

    <a-camera>
      <a-cursor position="0 0 -1" geometry="primitive:ring;radiusInner:0.02;radiusOuter:0.04"
                material="color:white;shader:flat;opacity:0.9"></a-cursor>
    </a-camera>
  </a-scene>

  <script type="module">
    const scores = {nerv: 0, anx: 0, stress: 0};
    const sceneEl = document.querySelector('a-scene');
    const modelsGroup = document.getElementById('models');
    let gameActive = false;
    let gameTimer;

    const positions = [
      {type:'nerv',   pos:' 5.0  1.2 -6',   scale:0.55}, {type:'nerv',   pos:'-7.5  3.8 -8',   scale:0.30},
      {type:'nerv',   pos:' 3.2  4.2 -12',  scale:0.40}, {type:'nerv',   pos:'-10  2.0 -10',  scale:0.60},
      {type:'nerv',   pos:' 9.0  0.8 -7',   scale:0.50}, {type:'nerv',   pos:'-4.0  3.5 -14',  scale:0.35},
      {type:'nerv',   pos:' 6.5  2.7 -11',  scale:0.45}, {type:'nerv',   pos:'-8.5  1.1 -13', scale:0.38},
      {type:'nerv',   pos:' 2.0  1.8 -9',   scale:0.62}, {type:'nerv',   pos:'-6.0  4.0 -6',   scale:0.28},

      {type:'anx',    pos:' 8.0  3.0 -9',   scale:0.58}, {type:'anx',    pos:'-9.0  1.5 -11',  scale:0.42},
      {type:'anx',    pos:' 4.5  2.5 -13',  scale:0.33}, {type:'anx',    pos:'-5.5  0.9 -8',   scale:0.65},
      {type:'anx',    pos:' 10  4.0 -10',   scale:0.48}, {type:'anx',    pos:'-3.0  2.2 -7',   scale:0.55},
      {type:'anx',    pos:' 7.0  1.6 -14',  scale:0.37}, {type:'anx',    pos:'-11  3.3 -12',  scale:0.50},
      {type:'anx',    pos:' 1.5  3.9 -10',  scale:0.30}, {type:'anx',    pos:'-7.0  2.8 -15',  scale:0.45},

      {type:'stress', pos:' 6.0  1.0 -10',  scale:0.60}, {type:'stress', pos:'-8.0  4.5 -9',   scale:0.35},
      {type:'stress', pos:' 3.8  3.2 -15',  scale:0.48}, {type:'stress', pos:'-6.5  2.0 -12',  scale:0.55},
      {type:'stress', pos:' 9.5  2.8 -8',   scale:0.40}, {type:'stress', pos:'-4.5  4.0 -11',  scale:0.38},
      {type:'stress', pos:' 5.0  3.7 -7',   scale:0.62}, {type:'stress', pos:'-10  1.8 -14',  scale:0.45},
      {type:'stress', pos:' 1.0  2.4 -13',  scale:0.52}, {type:'stress', pos:'-9.0  3.6 -6',   scale:0.30}
    ];

    document.getElementById('startGameBtn')?.addEventListener('click', startGame);
    document.getElementById('playAgainBtn')?.addEventListener('click', () => location.reload());

    function startGame() {
      document.getElementById('startPage').style.display = 'none';
      document.getElementById('gameUI').style.display = 'block';
      sceneEl.style.display = 'block';

      scores.nerv = scores.anx = scores.stress = 0;
      updateProgress();
      modelsGroup.innerHTML = '';
      gameActive = true;

      positions.forEach(item => {
        const wrapper = document.createElement('a-entity');
        wrapper.classList.add('clickable');
        wrapper.setAttribute('position', item.pos);
        wrapper.setAttribute('scale', `${item.scale} ${item.scale} ${item.scale}`);

        const model = document.createElement('a-entity');
        model.setAttribute('gltf-model', `#${item.type}`);
        wrapper.appendChild(model);

        const explosion = document.createElement('a-entity');
        explosion.setAttribute('gltf-model', '#destruction');
        explosion.setAttribute('visible', 'false');
        explosion.setAttribute('scale', '0.01 0.01 0.01');
        wrapper.appendChild(explosion);

        model.addEventListener('model-loaded', () => {
          const tick = () => {
            if (!wrapper.isConnected) return;
            wrapper.object3D.lookAt(sceneEl.camera.el.object3D.position);
            wrapper.object3D.rotateY(Math.PI);
            requestAnimationFrame(tick);
          };
          tick();
        });

        wrapper.addEventListener('click', function hit() {
          if (!gameActive) return;
          wrapper.removeEventListener('click', hit);
          scores[item.type]++;
          updateProgress();

          model.setAttribute('visible', 'false');
          explosion.setAttribute('visible', 'true');
          explosion.setAttribute('animation', `property:scale;to:${item.scale*7} ${item.scale*7} ${item.scale*7};dur:600;easing:easeOutCubic`);

          const sound = document.createElement('a-entity');
          sound.setAttribute('sound', 'src:#hit-sound;autoplay:true;volume:1');
          wrapper.appendChild(sound);

          setTimeout(() => wrapper.remove(), 1000);
        });

        modelsGroup.appendChild(wrapper);
      });

      let timeLeft = 30;
      document.getElementById('timer').textContent = '30';
      gameTimer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0) endGame();
      }, 1000);
    }

    function updateProgress() {
      const updateFill = (id, value) => {
        const fill = document.getElementById(id);
        fill.style.width = Math.min(value * 10, 100) + '%';
        fill.textContent = value;
      };
      updateFill('nerv-fill', scores.nerv);
      updateFill('anx-fill', scores.anx);
      updateFill('stress-fill', scores.stress);
    }

    function endGame() {
      gameActive = false;
      clearInterval(gameTimer);

      setTimeout(() => {
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('endScreen').style.display = 'flex';

        const updateEndFill = (id, value) => {
          const fill = document.getElementById(id);
          fill.style.width = Math.min(value * 10, 100) + '%';
          fill.textContent = value;
        };
        updateEndFill('end-nerv-fill', scores.nerv);
        updateEndFill('end-anx-fill', scores.anx);
        updateEndFill('end-stress-fill', scores.stress);
      }, 800);
    }
  </script>
</body>
</html>
