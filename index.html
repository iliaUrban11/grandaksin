<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Грандаксин против</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer@^3.5.0/dist/model-viewer.min.js"></script>
  <style>
    body{margin:0;background:#000;overflow:hidden;height:100vh;font-family:sans-serif}
    #ui{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;color:#fff}
    #timer{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(2,122,202,0.95);padding:14px 36px;border-radius:40px;font-size:3em;font-weight:900}
    #progress{position:fixed;top:100px;left:20px;right:20px;display:flex;gap:12px}
    .bar{flex:1;height:44px;background:rgba(255,255,255,0.2);border-radius:25px;overflow:hidden;position:relative}
    .fill{height:100%;width:0%;transition:width .8s ease}
    .label{position:absolute;top:50%;left:16px;transform:translateY(-50%);font-size:15px;font-weight:700;text-shadow:0 0 10px #000}
    #nerv-fill{background:#00859D}#anx-fill{background:#411D6B}#stress-fill{background:#EB4C24}
    #hint{position:fixed;bottom:30px;left:0;right:0;text-align:center;background:rgba(0,0,0,0.7);padding:16px;border-radius:15px;margin:0 20px;font-size:1.4em}
    #start{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:100;padding:24px 90px;font-size:2.4em;background:#027ACA;color:#fff;border:none;border-radius:60px;box-shadow:0 20px 50px rgba(0,0,0,0.6);cursor:pointer}
    model-viewer{position:fixed;width:100vw;height:100vh;display:none}
  </style>
</head>
<body>

<button id="start">НАЧАТЬ В AR</button>

<div id="ui" style="display:none">
  <div id="timer">30</div>
  <div id="progress">
    <div class="bar"><div class="label">Нервозность</div><div id="nerv-fill" class="fill"></div></div>
    <div class="bar"><div class="label">Тревога</div><div id="anx-fill" class="fill"></div></div>
    <div class="bar"><div class="label">Стресс</div><div id="stress-fill" class="fill"></div></div>
  </div>
  <div id="hint">Нажмите на симптом → он исчезнет!</div>
</div>

<div id="container"></div>

<script type="module">
  const container = document.getElementById('container');
  const models = [
    {type:'nerv', src:'https://v3x.me/grandaksin/nerv.glb'},
    {type:'anx',  src:'https://v3x.me/grandaksin/anx.glb'},
    {type:'stress',src:'https://v3x.me/grandaksin/stress.glb'}
  ];
  let scores = {nerv:0,anx:0,stress:0};
  let timeLeft = 30;
  let timer;

  document.getElementById('start').onclick = () => {
    document.getElementById('start').remove();
    document.getElementById('ui').style.display = 'block';
    spawn(20);
    timer = setInterval(()=> {
      timeLeft--;
      document.getElementById('timer').textContent = timeLeft;
      if(timeLeft<=0) endGame();
    },1000);
  };

  function spawn(count) {
    for(let i=0;i<count;i++) setTimeout(create, i*400);
  }

  function create() {
    if(timeLeft<=0) return;
    const m = models[Math.floor(Math.random()*models.length)];
    const mv = document.createElement('model-viewer');
    mv.src = m.src;
    mv.ar = true;
    mv.arModes = "webxr";           // ← вот ключ! Только WebXR → никакого окна
    mv.arScale = "auto";
    mv.cameraControls = true;
    mv.touchAction = "pan-y";
    mv.shadowIntensity = 1;
    mv.style.cssText = `position:absolute;width:140px;height:140px;left:${15+Math.random()*70}vw;top:${15+Math.random()*70}vh;display:none`;

    mv.addEventListener('ar-status', e => {
      if(e.detail.status==='session-started') mv.style.display='block';
    });

    mv.addEventListener('click', () => {
      if(timeLeft<=0) return;
      scores[m.type]++;
      document.getElementById(m.type+'-fill').style.width = Math.min(scores[m.type]*10,100)+'%';
      mv.remove();
      new Audio('https://assets.codepen.io/605876/sfx-hit.mp3').play();
      setTimeout(create, 500);
    });

    container.appendChild(mv);
  }

  function endGame() {
    clearInterval(timer);
    container.innerHTML = '';
    alert(`Время вышло!\n\nУничтожено симптомов:\nНервозность: ${scores.nerv}\nТревога: ${scores.anx}\nСтресс: ${scores.stress}\n\nГрандаксин — ваш союзник!`);
    location.reload();
  }
</script>
</body>
</html>
